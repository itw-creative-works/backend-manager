const { TEST_ACCOUNTS } = require('../../src/test/test-accounts.js');

/**
 * Test: Account Structure Validation
 * Verifies that all test accounts were created with the expected User helper fields
 * This catches failures in auth:on-create before other tests run
 */
module.exports = {
  description: 'Test accounts have required User structure',
  auth: 'none',
  timeout: 10000,

  async run({ accounts, assert, firestore }) {
    const accountIds = Object.keys(TEST_ACCOUNTS);

    for (const accountId of accountIds) {
      const account = accounts[accountId];

      // Check account was fetched
      assert.ok(account, `Account '${accountId}' should exist in accounts object`);
      assert.ok(account.uid, `Account '${accountId}' should have uid`);

      // Fetch full user doc from Firestore
      const userDoc = await firestore.get(`users/${account.uid}`);

      assert.ok(userDoc, `User doc for '${accountId}' should exist in Firestore`);

      // Validate auth fields (set by on-create)
      assert.hasProperty(userDoc, 'auth.uid', `Account '${accountId}' should have auth.uid`);
      assert.hasProperty(userDoc, 'auth.email', `Account '${accountId}' should have auth.email`);

      // Validate API fields (generated by on-create via User helper)
      assert.hasProperty(userDoc, 'api.clientId', `Account '${accountId}' should have api.clientId`);
      assert.hasProperty(userDoc, 'api.privateKey', `Account '${accountId}' should have api.privateKey`);

      // Validate privateKey was fetched correctly
      assert.ok(account.privateKey, `Account '${accountId}' privateKey should be fetched`);
      assert.equal(
        account.privateKey,
        userDoc.api.privateKey,
        `Account '${accountId}' fetched privateKey should match Firestore`
      );

      // Validate affiliate code (generated by on-create via User helper)
      assert.hasProperty(userDoc, 'affiliate.code', `Account '${accountId}' should have affiliate.code`);

      // Validate activity.created (set by on-create)
      assert.hasProperty(userDoc, 'activity.created.timestamp', `Account '${accountId}' should have activity.created.timestamp`);
      assert.hasProperty(userDoc, 'activity.created.timestampUNIX', `Account '${accountId}' should have activity.created.timestampUNIX`);

      // Validate plan fields (merged from test account properties)
      assert.hasProperty(userDoc, 'plan.id', `Account '${accountId}' should have plan.id`);
      assert.hasProperty(userDoc, 'plan.status', `Account '${accountId}' should have plan.status`);
    }

    return { success: true };
  },
};
